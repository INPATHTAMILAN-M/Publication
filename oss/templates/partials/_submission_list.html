<!-- <div class="job-style-two job-list-section"> -->
    <!-- <h2 align="center">Submitted Manuscripts</h2> -->
    <div class=”table-responsive”>  
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col">Manuscript ID</th>
                    <th scope="col" width="18%">Title</th>
                    <th scope="col">Action</th>
                    <th scope="col">Status</th>
                    <th scope="col">File</th>
                    <th scope="col">Submitted On</th>
                    <th scope="col">Decisioned on</th>
                    <th scope="col">Comments </th>
                </tr>
            </thead>
            <tbody>
                {% for submission in submissions %}
                <tr>
                    <td>{{ submission.manuscript_id }}</td>
                    <td>{{ submission.title }}</td>
                    <td>
                        <p>{{ submission.action }}</p>
                        <p><a href="#" class="upload-link" data-toggle="modal" data-target="#uploadModal" data-submission-id="{{ submission.id }}">Upload Additional Files</a></p>
                        <!-- <a href="#" class="upload-additional-files-link" data-submission-id="{{ submission.id }}" data-toggle="modal" data-target="#uploadModal">Upload Additional Files</a> -->
                        <p><a href="{% url 'contact_form' %}?email={{  admin_email }}" class="contact-link" target="_blank" onclick="window.open(this.href, '_blank', 'width=600,height=600'); return false;">Contact Admin</a> 
                        </p>
        
                    </td>
                    <td>{{ submission.article_status }}</td>
                    <td>

                        {# Files uploaded via Submission_Files relation - list all #}
                        {% for f in submission.submission_files_set.all %}
                            <div>
                                {% if f.file_category %}
                                    <small>{{ f.file_category.file_category }}:</small>
                                {% endif %}
                                <a href="{{ f.file.url }}" download>{{ f.file.name }}</a>
                            </div>
                        {% empty %}
                            {# Show placeholder only if there are no files at all #}
                            {% if not submission.final_file and not submission.additional_file and not submission.plag_report and not submission.copyright_file %}
                                --
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td>{{ submission.submitted_on|date:"d-M-Y" }}</td>
                    <td>{{ submission.decissioned_on|date:"d-M-Y" }}</td>
                    <td>
                        <a href="#" class="correction-comments-link" data-submission-id="{{ submission.id }}">Reviewer Comments</a>
                    </td>
                </tr>
                {% empty %}
                    <div class="author-card-step-two">
                        <div class="row">
                            <div class="col-md-12">
                                <p>No submitted manuscripts found.</p>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </tbody>
        </table>
    </div>
<!-- </div> -->

    <!-- Aggregated Reviewer Comments Modal -->
    <div class="modal fade" id="correctionCommentsModal" tabindex="-1" aria-labelledby="correctionCommentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="correctionCommentsModalLabel">Reviewer Comments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="correctionCommentsContent">
                        <div id="correctionCommentsText"></div>
                    </div>
                    <div id="noCorrectionComments" style="display:none;">
                        <p>No reviewer comments available for this submission.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function(){
        document.addEventListener('click', function(e){
            var t = e.target;
            // find nearest element with class correction-comments-link
            while(t && !t.classList && t.parentNode){
                t = t.parentNode;
            }
            if(!t) return;
            if(t.classList && t.classList.contains('correction-comments-link')){
                e.preventDefault();
                var submissionId = t.getAttribute('data-submission-id');
                if(!submissionId) return;

                var params = new URLSearchParams({ submission_id: submissionId });
                fetch('{% url "get_reviewer_details" %}?' + params.toString(), { credentials: 'same-origin' })
                    .then(function(resp){ if(!resp.ok) throw new Error('Network error'); return resp.json(); })
                    .then(function(data){
                        if(data.has_comments && Array.isArray(data.reviews) && data.reviews.length > 0){
                            var html = '';
                            data.reviews.forEach(function(rc){
                                var reviewer = rc.reviewer || 'Anonymous';
                                var recommendation = rc.recommendation ? ' - ' + rc.recommendation : '';
                                var submitted_on = rc.submitted_on ? (new Date(rc.submitted_on)).toLocaleString() : '';
                                var comments = rc.comments || '';

                                html += '<div style="margin-bottom:8px;border-left:3px solid #e9ecef;padding-left:8px;">';
                                html += '<strong>' + escapeHtml(reviewer) + '</strong>' + escapeHtml(recommendation);
                                html += '<div style="white-space:pre-wrap;margin-top:4px;">' + escapeHtml(comments) + '</div>';
                                if(submitted_on){ html += '<div class="text-muted" style="font-size:0.8em;margin-top:4px;">Submitted: ' + escapeHtml(submitted_on) + '</div>'; }
                                html += '</div>';
                            });

                            document.getElementById('correctionCommentsText').innerHTML = html;
                            document.getElementById('correctionCommentsContent').style.display = '';
                            document.getElementById('noCorrectionComments').style.display = 'none';
                        } else {
                            document.getElementById('noCorrectionComments').style.display = '';
                            document.getElementById('correctionCommentsContent').style.display = 'none';
                        }

                        // show modal
                        var modalEl = document.getElementById('correctionCommentsModal');
                        if(typeof bootstrap !== 'undefined' && bootstrap.Modal){
                            var modal = new bootstrap.Modal(modalEl);
                            modal.show();
                        } else if(window.jQuery){
                            $('#correctionCommentsModal').modal('show');
                        } else {
                            alert('Reviewer comments loaded');
                        }
                    }).catch(function(err){
                        console.error(err);
                        alert('Could not load reviewer comments.');
                    });
            }
        });

        function escapeHtml(str){
            if(!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
    })();
    </script>
