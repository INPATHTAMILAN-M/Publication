{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<section class="job-list-section pt-60 pb-60">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="about-information-sticky">
                    <ul>
                        <li>
                            <a class="nav-link" href="{% url 'editor_in_chief' %}">
                                Manuscripts waiting for decision
                            </a>
                        </li>
                        <li>
                            <a class="nav-link active" href="{% url 'decisioned_manuscripts' %}">
                                Manuscripts decisioned
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-9 ms-sm-auto col-lg-9 px-md-4">
                <div class="content">
                    <h2>Manuscripts History</h2>

                    <!-- Filter Form -->
                    <form method="GET" class="mb-3">
                        <div class="input-group">
                            <input type="text" name="search" class="form-control" placeholder="Search by title" value="{{ search_term }}">
                            <select name="status" class="form-select" onchange="this.form.submit()">
                                <option value="">All Statuses</option>
                                {% for status in all_statuses %}
                                    <option value="{{ status }}" {% if selected_status == status %}selected{% endif %}>
                                        {{ status }}
                                    </option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary">Search</button>
                        </div>
                    </form>
                    <div class=”table-responsive”>  
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th scope="col">Manuscript ID</th>
                                    <th scope="col" width="18%">Title</th>
                                    <th scope="col">Author</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">File</th>
                                    <th scope="col">Submitted on</th>
                                    <th scope="col">Comments</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for submission in submissions %}
                                <tr>
                                    <td>{{ submission.manuscript_id }}</td>
                                    <td>{{ submission.title }}</td>
                                    <td>{{ submission.author.get_full_name }}</td>
                                    <td>{{ submission.article_status }}</td>
                                    <td>
                                        {% if submission.final_file %}
                                        <a href="{{ submission.final_file.url }}" onclick="window.open(this.href, '_blank', 'toolbar=0,scrollbars=1,resizable=1,width=800,height=600'); return false;">View PDF</a>
                                        {% else %}
                                            --
                                        {% endif %}
                                    </td>
                                    <td>{{ submission.submitted_on }}</td>
                                    <td>
                                        <a href="#" class="correction-comments-link" data-submission-id="{{ submission.id }}">Reviewer Comments</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination controls -->
                    <div class="row pagination text-center">
                        <span class="step-links">
                            {% if submissions.has_previous %}
                                <a href="?page=1">&laquo; first</a>
                                <a href="?page={{ submissions.previous_page_number }}">previous</a>
                            {% endif %}
    
                            <span class="current">
                                Page {{ submissions.number }} of {{ submissions.paginator.num_pages }}
                            </span>
    
                            {% if submissions.has_next %}
                                <a href="?page={{ submissions.next_page_number }}">next</a>
                                <a href="?page={{ submissions.paginator.num_pages }}">last &raquo;</a>
                            {% endif %}
                        </span>
                    </div>
                    <!-- Aggregated Reviewer Comments Modal -->
                    <div class="modal fade" id="correctionCommentsModal" tabindex="-1" aria-labelledby="correctionCommentsModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="correctionCommentsModalLabel">Reviewer Comments</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="correctionCommentsContent">
                                        <div id="correctionCommentsText"></div>
                                    </div>
                                    <div id="noCorrectionComments" style="display:none;">
                                        <p>No reviewer comments available for this submission.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                    (function(){
                        document.addEventListener('click', function(e){
                            var t = e.target;
                            while(t && !t.classList && t.parentNode){ t = t.parentNode; }
                            if(!t) return;
                            if(t.classList && t.classList.contains('correction-comments-link')){
                                e.preventDefault();
                                var submissionId = t.getAttribute('data-submission-id');
                                if(!submissionId) return;

                                var params = new URLSearchParams({ submission_id: submissionId });
                                fetch('{% url "get_reviewer_details" %}?' + params.toString(), { credentials: 'same-origin' })
                                    .then(function(resp){ if(!resp.ok) throw new Error('Network error'); return resp.json(); })
                                    .then(function(data){
                                        if(data.has_comments && Array.isArray(data.reviews) && data.reviews.length > 0){
                                            var html = '';
                                            data.reviews.forEach(function(rc){
                                                var reviewer = rc.reviewer || 'Anonymous';
                                                var recommendation = rc.recommendation ? ' - ' + rc.recommendation : '';
                                                var submitted_on = rc.submitted_on ? (new Date(rc.submitted_on)).toLocaleString() : '';
                                                var comments = rc.comments || '';

                                                html += '<div style="margin-bottom:8px;border-left:3px solid #e9ecef;padding-left:8px;">';
                                                html += '<strong>' + escapeHtml(reviewer) + '</strong>' + escapeHtml(recommendation);
                                                html += '<div style="white-space:pre-wrap;margin-top:4px;">' + escapeHtml(comments) + '</div>';
                                                if(submitted_on){ html += '<div class="text-muted" style="font-size:0.8em;margin-top:4px;">Submitted: ' + escapeHtml(submitted_on) + '</div>'; }
                                                html += '</div>';
                                            });

                                            document.getElementById('correctionCommentsText').innerHTML = html;
                                            document.getElementById('correctionCommentsContent').style.display = '';
                                            document.getElementById('noCorrectionComments').style.display = 'none';
                                        } else {
                                            document.getElementById('noCorrectionComments').style.display = '';
                                            document.getElementById('correctionCommentsContent').style.display = 'none';
                                        }

                                        var modalEl = document.getElementById('correctionCommentsModal');
                                        if(typeof bootstrap !== 'undefined' && bootstrap.Modal){
                                            var modal = new bootstrap.Modal(modalEl);
                                            modal.show();
                                        } else if(window.jQuery){
                                            $('#correctionCommentsModal').modal('show');
                                        } else {
                                            alert('Reviewer comments loaded');
                                        }
                                    }).catch(function(err){
                                        console.error(err);
                                        alert('Could not load reviewer comments.');
                                    });
                            }
                        });

                        function escapeHtml(str){
                            if(!str) return '';
                            return String(str)
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/\"/g, '&quot;')
                                .replace(/'/g, '&#39;');
                        }
                    })();
                    </script>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
